====== ADP8860 Back-light LED Linux Driver ======

===== Supported Devices =====

  * [[adi>ADP8860]]
  * [[adi>ADP8861]]
  * [[adi>ADP8863]]

===== Evaluation Boards =====

  * [[adi>ADP8860DBCB-EVALZ]]
  * [[adi>ADP8860DBCP-EVALZ]]
  * [[adi>ADP8861DBCB-EVALZ]]
  * [[adi>ADP8863DBCB-EVALZ]]
  * [[adi>ADP8863DBCP-EVALZ]]
===== Description =====

{{:software:driver:linux:adp8860_typical_operating_circuit.png|}}
===== Configuration =====


===== Software configurable features =====

Backlight:
^ Feature ^ ADP8860 ^ ADP8863 ^ ADP8861 ^
| Ambient Light Sensor Support (ALS) | ✔ | ✔ | ✘ |
| Three programmable ambient light sensing \\ zones for optimal backlight power savings | ✔ | ✔ | ✘ |
| Configurable Fade On/Off times  | ✔ | ✔ | ✔ |
| Configurable Fade Law functions  | ✔ | ✔ | ✔ |
| Configurable ALS filter settings | ✔ | ✔ | ✘ |
| Configurable Brightness/Intensity in 128 steps  | ✔ | ✔ | ✔ |

LED:
^ Feature ^ ADP8860 ^ ADP8863 ^ ADP8861 ^
| Up to 7 LEDs configurable  | ✔ | ✔ | ✔ |
| Configurable Fade On/Off times  | ✔ | ✔ | ✔ |
| LED Blink On/Off times  | ✔ | ✔ | ✔ |
| Configurable Fade Law functions  | ✔ | ✔ | ✔ |
| Configurable Brightness/Intensity in 128 steps from [0..255]  | ✔ | ✔ | ✔ |

====== Source Code ======

===== Status =====

^ Source ^ Mainlined? ^
| [[git.linux.org>drivers/video/backlight/adp8860_bl.c|git]] | [[git.linux.org>drivers/video/backlight/adp8860_bl.c|Yes]] |

===== Files =====

^ Function ^ File ^
| driver  | [[git.linux.org>drivers/video/backlight/adp8860_bl.c]] |
| include | [[git.linux.org>include/linux/i2c/adp8860.h]] |

====== Instructions / Theory of operation ======


===== Backlight control =====

With the ADP8860 driver installed, you will find sysfs files in the\\
/sys/class/backlight/adp8860_bl/\\
directory. You will be able to query and set the current screen\\
brightness:\\

  ; **brightness** : get/set screen brightness (an integer between 0 and 126)\\ writing 127 will enable the Ambient Light Sensor.
  ; **actual_brightness** : reading from this file will query the HW to get real brightness value.
  ; **max_brightness** : the maximum brightness value.
  ; **bl_power** : Current FB Power mode (0: full on, 1..3: power saving modes; 4: full off).

==== ADP8860 Specific Backlight controls ====

The ADP8860 features 3 individually programmable Ambient Light Sensing Zones:


  ; **l1_daylight_dim** : Ambient Light
 Zone Daylight: Backlight DIM Intensity (an integer between 0 and 127, typically set to 0).
  ; **l1_daylight_max** : Ambient Light Zone Daylight: Backlight Intensity (an integer between 0 and 127).
  ; **l2_office_dim** : Ambient Light Zone Office: Backlight DIM Intensity (an integer between 0 and 127, typically set to 0)
  ; **l2_office_max** : Ambient Light Zone Office: Backlight Intensity (an integer between 0 and 127)
  ; **l3_dark_dim**	 : Ambient Light Zone Dark: Backlight DIM Intensity (an integer between 0 and 127, typically set to 0)
  ; **l3_dark_max**	 : Ambient Light Zone Dark: Backlight Intensity (an integer between 0 and 127)


  ; **ambient_light_level** : Get conversion value of the first light sensor. This value is updated every 80 ms \\ (when the light sensor is enabled). Returns integer between 0 (dark) and 8000 (max ambient brightness)
  ; **ambient_light_zone** : Get/Set current Ambient Light Zone. Reading returns integer between 1..3 \\ (1 = Daylight, 2 = office, 3 = dark). Writing a value between 1..3 forces the Backlight controller \\ to enter the corresponding Ambient Light Zone. Writing 0 returns to normal operation.

===== LED handling under Linux =====

LEDs not assigned to the Backlight are optionally exposed to the Linux LEDs Class.\\

The LED class allows control of LEDs from userspace.
LEDs appear in /sys/class/leds/. The brightness file will
set the brightness of the LED (taking a value 0-255).
The LEDS class also introduces the optional concept of an LED trigger. A trigger
is a kernel based source of led events, such as ide-disk or backlight control.\\
For more information read linux/Documentaion/leds-class.txt

  ; **brightness** : get/set LED brightness (an integer between 0 and 255)
  ; **max_brightness** : the maximum brightness value.


====== Example platform device initialization ======

{{page>software/linux/docs/platform_and_bus_model#Platform Data&noheader&firstseconly&noeditbtn}}

<WRAP info>
**platform_data: Platform data specific to the ADP8860 device.**\\
Includes what LEDs are available, feature selections and default initialization.
</WRAP>

<code c>
#include <linux/i2c/adp8860.h>
</code>

<source trunk/arch/blackfin/mach-bf537/boards/stamp.c:adp8860_leds{} c linux-kernel>
<source trunk/arch/blackfin/mach-bf537/boards/stamp.c:adp8860_pdata{} c linux-kernel>

{{page>software/linux/docs/platform_and_bus_model#Declaring I2C devices&firstseconly&noeditbtn}}

<code C>
static struct i2c_board_info __initdata bfin_i2c_board_info[] = {
#if defined(CONFIG_BACKLIGHT_ADP8860) || defined(CONFIG_BACKLIGHT_ADP8860_MODULE)
	{
		I2C_BOARD_INFO("adp8860", 0x2A),
		.platform_data = (void *)&adp8860_pdata,
	},
#endif
}
</code>
====== Adding Linux driver support ======


Configure kernel with "make menuconfig" (alternatively use "make xconfig" or
"make qconfig")

<WRAP tip>
The ADP8860 Backlight driver depends on I2C.
It therefore requires selected I2C support to show up during kernel configuration.
</WRAP>

<xterm>
Device Drivers  --->
	Graphics support  --->
		[*] Backlight & LCD device support  ---
</xterm>

====== ADP8860 Back-light LED Linux Driver ======

===== Supported Devices =====

  * [[adi>ADP8860]]
  * [[adi>ADP8861]]
  * [[adi>ADP8863]]

===== Evaluation Boards =====

  * [[adi>ADP8860DBCB-EVALZ]]
  * [[adi>ADP8860DBCP-EVALZ]]
  * [[adi>ADP8861DBCB-EVALZ]]
  * [[adi>ADP8863DBCB-EVALZ]]
  * [[adi>ADP8863DBCP-EVALZ]]
===== Description =====

{{:software:driver:linux:adp8860_typical_operating_circuit.png|}}
===== Configuration =====


===== Software configurable features =====

Backlight:
^ Feature ^ ADP8860 ^ ADP8863 ^ ADP8861 ^
| Ambient Light Sensor Support (ALS) | ✔ | ✔ | ✘ |
| Three programmable ambient light sensing \\ zones for optimal backlight power savings | ✔ | ✔ | ✘ |
| Configurable Fade On/Off times  | ✔ | ✔ | ✔ |
| Configurable Fade Law functions  | ✔ | ✔ | ✔ |
| Configurable ALS filter settings | ✔ | ✔ | ✘ |
| Configurable Brightness/Intensity in 128 steps  | ✔ | ✔ | ✔ |

LED:
^ Feature ^ ADP8860 ^ ADP8863 ^ ADP8861 ^
| Up to 7 LEDs configurable  | ✔ | ✔ | ✔ |
| Configurable Fade On/Off times  | ✔ | ✔ | ✔ |
| LED Blink On/Off times  | ✔ | ✔ | ✔ |
| Configurable Fade Law functions  | ✔ | ✔ | ✔ |
| Configurable Brightness/Intensity in 128 steps from [0..255]  | ✔ | ✔ | ✔ |

====== Source Code ======

===== Status =====

^  Source  ^  Mainlined?  ^
| [[git.linux.org>drivers/video/backlight/adp8860_bl.c|git]] |  [[git.linux.org>drivers/video/backlight/adp8860_bl.c|Yes]]  |

===== Files =====

^ Function ^ File ^
| driver  | [[git.linux.org>drivers/video/backlight/adp8860_bl.c]] |
| include | [[git.linux.org>include/linux/i2c/adp8860.h]] |

====== Instructions / Theory of operation ======


===== Backlight control =====

With the ADP8860 driver installed, you will find sysfs files in the\\
/sys/class/backlight/adp8860_bl/\\
directory. You will be able to query and set the current screen\\
brightness:\\

  ; **brightness** : get/set screen brightness (an integer between 0 and 126)\\ writing 127 will enable the Ambient Light Sensor.
  ; **actual_brightness** : reading from this file will query the HW to get real brightness value.
  ; **max_brightness** : the maximum brightness value.
  ; **bl_power** : Current FB Power mode (0: full on, 1..3: power saving modes; 4: full off).

==== ADP8860 Specific Backlight controls ====

The ADP8860 features 3 individually programmable Ambient Light Sensing Zones:


  ; **l1_daylight_dim** : Ambient Light
 Zone Daylight: Backlight DIM Intensity (an integer between 0 and 127, typically set to 0).
  ; **l1_daylight_max** : Ambient Light Zone Daylight: Backlight Intensity (an integer between 0 and 127).
  ; **l2_office_dim** : Ambient Light Zone Office: Backlight DIM Intensity (an integer between 0 and 127, typically set to 0)
  ; **l2_office_max** : Ambient Light Zone Office: Backlight Intensity (an integer between 0 and 127)
  ; **l3_dark_dim**	 : Ambient Light Zone Dark: Backlight DIM Intensity (an integer between 0 and 127, typically set to 0)
  ; **l3_dark_max**	 : Ambient Light Zone Dark: Backlight Intensity (an integer between 0 and 127)


  ; **ambient_light_level** : Get conversion value of the first light sensor. This value is updated every 80 ms \\ (when the light sensor is enabled). Returns integer between 0 (dark) and 8000 (max ambient brightness)
  ; **ambient_light_zone** : Get/Set current Ambient Light Zone. Reading returns integer between 1..3 \\ (1 = Daylight, 2 = office, 3 = dark). Writing a value between 1..3 forces the Backlight controller \\ to enter the corresponding Ambient Light Zone. Writing 0 returns to normal operation.

===== LED handling under Linux =====

LEDs not assigned to the Backlight are optionally exposed to the Linux LEDs Class.\\

The LED class allows control of LEDs from userspace.
LEDs appear in /sys/class/leds/. The brightness file will
set the brightness of the LED (taking a value 0-255).
The LEDS class also introduces the optional concept of an LED trigger. A trigger
is a kernel based source of led events, such as ide-disk or backlight control.\\
For more information read linux/Documentaion/leds-class.txt

  ; **brightness** : get/set LED brightness (an integer between 0 and 255)
  ; **max_brightness** : the maximum brightness value.


====== Example platform device initialization ======

{{page>software/linux/docs/platform_and_bus_model#Platform Data&noheader&firstseconly&noeditbtn}}

<WRAP info>
**platform_data: Platform data specific to the ADP8860 device.**\\
Includes what LEDs are available, feature selections and default initialization.
</WRAP>

<code c>
#include <linux/i2c/adp8860.h>
</code>

<source trunk/arch/blackfin/mach-bf537/boards/stamp.c:adp8860_leds{} c linux-kernel>
<source trunk/arch/blackfin/mach-bf537/boards/stamp.c:adp8860_pdata{} c linux-kernel>

{{page>software/linux/docs/platform_and_bus_model#Declaring I2C devices&firstseconly&noeditbtn}}

<code C>
static struct i2c_board_info __initdata bfin_i2c_board_info[] = {
#if defined(CONFIG_BACKLIGHT_ADP8860) || defined(CONFIG_BACKLIGHT_ADP8860_MODULE)
	{
		I2C_BOARD_INFO("adp8860", 0x2A),
		.platform_data = (void *)&adp8860_pdata,
	},
#endif
}
</code>

====== Adding Linux driver support ======


Configure kernel with "make menuconfig" (alternatively use "make xconfig" or
"make qconfig")

<WRAP tip>
The ADP8860 Backlight driver depends on I2C.
It therefore requires selected I2C support to show up during kernel configuration.
</WRAP>

<xterm>
Device Drivers  --->
	Graphics support  --->
		[*] Backlight & LCD device support  --->
			<*>   Lowlevel Backlight controls
			<M>   Backlight Driver for ADP8860 using WLED
</xterm>

====== Hardware configuration ======

During test and driver development we used the ADP8860 Evaluation Mother/Daughter Board.

{{:software:driver:linux:adp8870_adaptor_board_lr.jpg?512|}}

It can be easily wired to the Blackfin STAMP TWI/I2C header.

^ BF537-STAMP (P10) TWI/I2C header  ^^ ADP886x Adaptor Board (J30) ^
^ PIN ^ Function ^ PIN/Function ^
| 5 | SCL | SCL |
| 6 | SDA| SDA |
| 20 | GND | GND |

Leave J31 and J32 open (these jumpers connect the SCL and SDA to the cypress chip used as USB bridge).  Then apply your own SCL, SDA, and GND to the big J30 connector on the left edge of the board.

The ADP8860 chip still needs Vin (to power the chip), Vddio (to pull nRST and nINT high), and Vboard (to power the ALS sensor on the daughter card).  These are provided through the USB port and then get regulated down (Vin becomes 3.6V, Vddio is 2.7V, and Vboard is around 4 V). So even though you won't be using the USB to program the part, it would still be easiest to plug the board into a USB port just to power Vin, Vddio, and Vboard.  Of course, if you want, you can power these supplies from a lab bench power supply.  In that case, move LK1, 2, and 3 to the "EXT" position and apply the signals to J29.


====== Driver testing ======

===== Driver compiled as a module =====

**ADP8860 driver is build as a module**
<xterm>
root:/> **modprobe adp8860_bl**
adp8860_bl 0-002a: Rev.7 Backlight
Registered led device: adp8860-led7
root:/>
</xterm>

==== Example Backlight usage ====

<xterm>
root:/> cd sys/class/backlight/adp8860_bl/
root:/sys/devices/platform/i2c-bfin-twi.0/i2c-adapter/i2c-0/0-002a/backlight/adp8860_bl> ls -l
-r--r--r--    1 root     root         4096 Jan  1 03:29 actual_brightness
-r--r--r--    1 root     root         4096 Jan  1 03:29 ambient_light_level
-rw-rw-r--    1 root     root         4096 Jan  1 03:29 ambient_light_zone
-rw-r--r--    1 root     root         4096 Jan  1 03:31 bl_power
-rw-r--r--    1 root     root         4096 Jan  1 04:55 brightness
lrwxrwxrwx    1 root     root            0 Jan  1 03:29 device -> ../../../0-002a
-rw-rw-r--    1 root     root         4096 Jan  1 03:29 l1_daylight_dim
-rw-rw-r--    1 root     root         4096 Jan  1 03:29 l1_daylight_max
-rw-rw-r--    1 root     root         4096 Jan  1 03:30 l2_office_dim
-rw-rw-r--    1 root     root         4096 Jan  1 03:29 l2_office_max
-rw-rw-r--    1 root     root         4096 Jan  1 03:31 l3_dark_dim
-rw-rw-r--    1 root     root         4096 Jan  1 03:29 l3_dark_max
-r--r--r--    1 root     root         4096 Jan  1 03:29 max_brightness
drwxr-xr-x    2 root     root            0 Jan  1 03:29 power
lrwxrwxrwx    1 root     root            0 Jan  1 03:29 subsystem -> ../../../../../../../../class/backlight
-rw-r--r--    1 root     root         4096 Jan  1 03:29 uevent
root:/sys/devices/platform/i2c-bfin-twi.0/i2c-adapter/i2c-0/0-002a/backlight/adp8860_bl>
</xterm>

=== Set Backlight Intensity ===

<xterm>
root:/sys/devices/platform/i2c-bfin-twi.0/i2c-adapter/i2c-0/0-002a/backlight/adp8860_bl> **echo 42 > brightness**
</xterm>

=== Query Backlight Intensity ===

<xterm>
root:/sys/devices/platform/i2c-bfin-twi.0/i2c-adapter/i2c-0/0-002a/backlight/adp8860_bl> **cat brightness**
42
</xterm>

=== Enable Ambient Light Sensing Feature ===

<xterm>
root:/sys/devices/platform/i2c-bfin-twi.0/i2c-adapter/i2c-0/0-002a/backlight/adp8860_bl> **echo 127 > brightness**
</xterm>

=== Query Ambient Light Level ===

<xterm>
root:/sys/devices/platform/i2c-bfin-twi.0/i2c-adapter/i2c-0/0-002a/backlight/adp8860_bl> **cat ambient_light_level**
1276
</xterm>

=== Query Ambient Light Zone ===

<xterm>
root:/sys/devices/platform/i2c-bfin-twi.0/i2c-adapter/i2c-0/0-002a/backlight/adp8860_bl> **cat ambient_light_zone**
2
</xterm>

=== Adjust Intensity for Ambient Light Zone 2 (office) ===

<xterm>
root:/sys/devices/platform/i2c-bfin-twi.0/i2c-adapter/i2c-0/0-002a/backlight/adp8860_bl> **echo 22 > l2_office_max**
22
</xterm>

<xterm>
root:/sys/devices/platform/i2c-bfin-twi.0/i2c-adapter/i2c-0/0-002a/backlight/adp8860_bl> **cat l2_office_max**
22
</xterm>

==== Example LED usage ====
<xterm>
root:/> cd /sys/class/leds/adp8860-led7/
root:/sys/devices/platform/i2c-bfin-twi.0/i2c-adapter/i2c-0/0-002a/leds/adp8860-led7> ls -l
-rw-r--r--    1 root     root         4096 Jan  1 03:29 brightness
lrwxrwxrwx    1 root     root            0 Jan  1 03:29 device -> ../../../0-002a
-r--r--r--    1 root     root         4096 Jan  1 03:29 max_brightness
drwxr-xr-x    2 root     root            0 Jan  1 03:29 power
lrwxrwxrwx    1 root     root            0 Jan  1 03:29 subsystem -> ../../../../../../../../class/leds
</xterm>

=== Set Intensity ===

<xterm>
root:/sys/devices/platform/i2c-bfin-twi.0/i2c-adapter/i2c-0/0-002a/leds/adp8860-led7>**echo 99 > brightness**
</xterm>
=== Turn LED OFF ===
<xterm>
root:/sys/devices/platform/i2c-bfin-twi.0/i2c-adapter/i2c-0/0-002a/leds/adp8860-led7> **echo 0 > brightness**
</xterm>
=== Query Max Brightness ===
<xterm>
root:/sys/devices/platform/i2c-bfin-twi.0/i2c-adapter/i2c-0/0-002a/leds/adp8860-led7> **cat max_brightness**
255
root:/sys/devices/platform/i2c-bfin-twi.0/i2c-adapter/i2c-0/0-002a/leds/adp8860-led7>
</xterm>

====== More Information ======
